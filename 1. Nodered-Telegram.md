# Lab 1. Watson Assistant and Telegram integration via Node-red

* [Lab 1. Watson Assistant and Telegram integration via Node-red](#Lab-1.-Watson-Assistant-and-Telegram-integration-via-Node-red)
   * [1. Установка Node-red](#1-установка-node-red)
   * [2. Развертывание сервисов Watson](#2-развертывание-сервисов-watson)
      * [2.1. Создайте сервис IBM Watson Assistant](#21-создайте-сервис-ibm-watson-assistant)
      * [2.2. Создайте сервис IBM Watson Visual Recognition](#22-создайте-сервис-ibm-watson-visual-recognition)
      * [2.3. Создайте сервис IBM Language Translator](#23-создайте-сервис-ibm-language-translator)
   * [3. Создадим бота Telegram](#3-создадим-бота-telegram)
   * [4. Сконфигурируем Node-RED](#4-сконфигурируем-node-red)
   * [4.1. Запуск Node-RED](#41-запуск-node-red)
   * [4.2. Импорт конфигурации](#42-импорт-конфигурации)
   * [4.3. Добавим конфигурацию Telegram к Node-RED](#43-добавим-конфигурацию-telegram-к-node-red)
   * [4.4. Сконфигурируем сервис Telegram в Node-RED](#44-сконфигурируем-сервис-telegram-в-node-red)
   * [4.5. Сконфигурируем подключение к сервису IBM Watson Assistant в Node-RED](#45-сконфигурируем-подключение-к-сервису-ibm-watson-assistant-в-node-red)
   * [4.6. Сконфигурируем подключение к сервису Watson Visual Recognition в Node-RED](#46-сконфигурируем-подключение-к-сервису-watson-visual-recognition-в-node-red)
   * [4.7. Сконфигурируем сервис Language Translator в Node-RED](#47-сконфигурируем-сервис-language-translator-в-node-red)
   * [5. Протестируем бота](#5-протестируем-бота)


## 1. Understand your default region
- Login to https://cloud.ibm.com
- Go to **Manage - Account - Cloud Foundry orgs**
- You should see your default organization. Click on the actions icon on the right, and select "Spaces":

<img src="images/cloudorg-spaces.png" width="200"/>

- You should now see your default region (i.e. **United Kingdom**). Use this region as your default for all your services below.
Your lite account will **not** allow to create services in multiple regions, unless you apply a promo code to your account requested at https://ibm.biz/ibmcloudcoupon

## 2. Node-red installation

- Follow the steps at https://developer.ibm.com/components/node-red/tutorials/how-to-create-a-node-red-starter-application/ to install node-red in your account. Note that you should use your default region (step 1) to install it.

## 3. Watson Services configuration
We will need to have the following services installed:
- IBM Watson Assistant
- IBM Watson Visual Recognition

### 3.1. IBM Watson Assistant
- Download watson pizzeria bot example: <a href="https://raw.githubusercontent.com/agavrin/WatsonAssistantEng/master/files/watson-pizzeria.json">watson-pizzeria.json</a>

- Create a new instance or open an existing instance of IBM Watson Assistant service

- Go to your WA instance, and click on the Service credentials tab:

<img width="500" src="images/wa-service-credentials.png"/>

- Import pizza bot into a skill by going to **Skills - Create Skill - Dialog Skill - Next - Import skill - Choose JSON File**.

Сохраните значения API Key и Url этого бота.

### 2.2. IBM Watson Visual Recognition
- Enter IBM cloud catalog
https://cloud.ibm.com/catalog

- Select **Services** - AI / Machine learning - **Visual Recognition**

- Click Create.

- Go into the "Manage" tab and save API Key and URL.

<img src="images/vr-key.png" width="400"/>

### 2.3. IBM Language Translator (optional)
- Enter IBM cloud catalog
https://cloud.ibm.com/catalog

- Select **Services** - AI / Machine learning - **Lanuage Translator**

- Click Create.

- Go into the **Service credentials** tab and save API Key and URL.

<img src="images/lt-creds.png" width="400"/>

## 3. Create Telegram-bot
To create a bot:
- open Telegram appliccation and look for **BotFather** id. Send "/newbot" command to BotFather.
- you need to enter your bot name and send it to BotFather. At the end - you will get a token - that will be your key to access your bot. Save your key (you  maysend it to your email as an example) - you will need it for configuration later.

## 4. Configure Node-RED

## 4.1. Start Node-RED

Go to IBM Cloud resources dashboard:
https://cloud.ibm.com/resources
Look up your Node-RED instance, created at step 2. Click on it.

<img src="images/node-red-main.png" width="400"/>

- Click on **App URL**
- You should go through the process of initial setup of node red. Enter userid and password to configure your instance later.
- Click Next - Next - Finish.
-  You will see your Node-RED flow editor
<img src="images/nodered-screen.png" width="400">


## 4.2. Import configuration

Download configuration:
<a href="//raw.githubusercontent.com/agavrin/WatsonAssistantEng/master/files/NodeRed-WatsonAssistantFlow.js">here</a>

Go to Node-RED configuration, click on the right hamburger menu, then **Import** - **select a file**

Impiort configuration, you may see import error, complaining about missing telegram controls. Let's import those:


## 4.3. Добавим конфигурацию Telegram к Node-RED
- Go to Manage Palette - Install
- Enter "telegram" into the search field

Select **node-red-contrib-telegrambot** and click Install

At the end you will see telegram bot nodes at the left panel.



<img src="images/7-nodered-installtelegram-done.png"/>

## 4.4. Сконфигурируем сервис Telegram в Node-RED

Нажмите на Telegram Receiver. Рядом с названием PizzaBot нажните на значок редактирования и введите API Token от телеграм бота в окне Token:

<img src="images/7-nodered-installtelegram-token.png" width="400"/>

Сделайте то же самое для Telegram Sender, Нажмите Update и Deploy (в правом верхнем углу).

<img src="images/7-nodered-installtelegram-connected1.png" width="200"/><img src="images/7-nodered-installtelegram-connected2.png" width="200"/>

## 4.5. Сконфигурируем подключение к сервису IBM Watson Assistant в Node-RED

Нажмите на блок Watson Assistant

Вам нужно ввести:
- Username
- Password
- Workspace ID

Проверьте gateway - он должен совпадать с тем, что указан в сервисе

Нажмите Done

## 4.6. Сконфигурируем подключение к сервису Watson Visual Recognition в Node-RED

Нажмите на блок Watson Visual Recognition

Вам нужно ввести:
- API Key

Выберите соответствующий endpoint (из конфигурации сервиса)

Нажмите Done

## 4.7. Сконфигурируем сервис Language Translator в Node-RED

Нажмите на блок translator

Вам нужно ввести:
- Username
- Password
- Use Default Service Endpoint - отключите опцию и добавьте свой из сервиса Language Translator

Проверьте gateway - он должен совпадать с тем, что указан в сервисе

Проверьте:
- Use Experimental Neural Translation - включено
- Domains: General
- Source: English
- Target: Russian
- Not using translation utility

Нажмите Done

## 5. Протестируем бота

Попробуйте обратиться к Вашему боту через приложение telegram.

Пример вопроса:
"Хочу пиццу"
"хочу большую сырную пиццу с анчоусами и оливками"

Отправьте фотографию какого-нибудь объекта. Watson распознает объект и вернет его название на Русском языке.
